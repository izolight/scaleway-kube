---
- name: override kubelet unit file
  copy:
    src: 20-etcd-service-manager.conf
    dest: /etc/systemd/system/kubelet.service.d/20-etcd-service-manager.conf

- name: restart kubelet
  systemd:
    name: kubelet
    daemon-reload: yes
    state: restarted

- name: add kubeadm config
  template:
    src: kubeadmcfg.yaml
    dest: /tmp/

- name: generate etcd ca
  shell: kubeadm alpha phase certs etcd-ca
  args:
    creates: /etc/kubernetes/pki/etcd/ca.crt
  when: inventory_hostname in groups['etcd_ca']

- name: generate ssh key for ca server
  shell: ssh-keygen -t ed25519 -f /root/.ssh/id_ed25519 -q -N ""
  args:
    creates: /root/.ssh/id_ed25519
  when: inventory_hostname in groups['etcd_ca']

- name: get ssh public key
  slurp:
    src: /root/.ssh/id_ed25519.pub
  register: ssh_public_key
  delegate_to: "{{ groups['etcd_ca'][0] }}"

- name: add key to authorized keys
  authorized_key:
    user: root
    key: "{{ ssh_public_key.content | b64decode }}" 
  when: inventory_hostname in groups['etcd_noca']

- name: copy ca to other hosts
  synchronize:
    src: /etc/kubernetes/pki/etcd
    dest: /etc/kubernetes/pki/
  delegate_to: "{{ groups['etcd_ca'][0] }}"
  when: inventory_hostname in groups['etcd_noca']

- name: create server cert
  shell: kubeadm alpha phase certs etcd-server --config=/tmp/kubeadmcfg.yaml
  args:
    creates: /etc/kubernetes/pki/etcd/server.crt
